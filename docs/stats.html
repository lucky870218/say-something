<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ç•™è¨€å‹Ÿé›†ï½œé€²éšå€é–“æ•¸æ“šä¸­å¿ƒ</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; }
    
    /* ç¯©é¸æ§åˆ¶åˆ— */
    .filter-bar { 
      background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; 
      display: flex; gap: 15px; align-items: center; flex-wrap: wrap; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    input[type="date"] { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; outline: none; }
    input[type="date"]:focus { border-color: #007bff; }
    button.reset-btn { padding: 8px 16px; background: #666; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button.reset-btn:hover { background: #444; }

    /* çµ±è¨ˆæ•¸å­—å¡ç‰‡ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .card { 
      background: #fff; padding: 20px; border-radius: 12px; text-align: center; 
      cursor: pointer; border: 2px solid transparent; transition: all 0.2s; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card.active { border-color: #007bff; background: #f0f7ff; }
    .card h3 { margin: 0; font-size: 14px; color: #666; }
    .card .num { font-size: 28px; font-weight: bold; margin-top: 8px; color: #111; }

    /* ä¸»å…§å®¹å€ */
    .main-content { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
    @media (max-width: 850px) { .main-content { grid-template-columns: 1fr; } }
    
    .chart-box, .list-box { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
    .list-box { max-height: 600px; overflow-y: auto; }
    
    /* ç•™è¨€åˆ—è¡¨æ¨£å¼ */
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .msg-item { border-bottom: 1px solid #f0f0f0; padding: 15px 0; }
    .msg-item:last-child { border: 0; }
    .topic-tag { font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 6px; }
    .tag-å”å¯¶å¯¶ { background: #ffeaa7; color: #d35400; }
    .tag-ç¤¾æœƒ { background: #fab1a0; color: #c0392b; }
    .tag-åœ°çƒ { background: #55efc4; color: #009432; }
    .msg-text { font-size: 15px; line-height: 1.5; word-break: break-all; }
    .msg-time { font-size: 11px; color: #999; margin-top: 8px; }
  </style>
</head>

<body>
  <div class="container">
    <div style="text-align:center; margin-bottom: 25px;">
      <h1>æ´»å‹•ç•™è¨€å³æ™‚çµ±è¨ˆ</h1>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <strong>ğŸ“… ç¯©é¸å€é–“ï¼š</strong>
        <input type="date" id="startDate">
        <span>è‡³</span>
        <input type="date" id="endDate">
        <button class="reset-btn" onclick="resetFilters()">é‡ç½®å€é–“</button>
      </div>
      <div id="filterStatus" style="font-size: 14px; color: #666;"></div>
    </div>

    <div class="stats-grid">
      <div class="card active" id="card-all" onclick="filterByTopic('')">
        <h3>å€é–“ç¸½ç•™è¨€</h3>
        <div class="num" id="stat-total">0</div>
      </div>
      <div class="card" id="card-å”å¯¶å¯¶" onclick="filterByTopic('å”å¯¶å¯¶')">
        <h3>å”å¯¶å¯¶</h3>
        <div class="num" id="stat-å”å¯¶å¯¶">0</div>
      </div>
      <div class="card" id="card-ç¤¾æœƒ" onclick="filterByTopic('ç¤¾æœƒ')">
        <h3>ç¤¾æœƒ</h3>
        <div class="num" id="stat-ç¤¾æœƒ">0</div>
      </div>
      <div class="card" id="card-åœ°çƒ" onclick="filterByTopic('åœ°çƒ')">
        <h3>åœ°çƒ</h3>
        <div class="num" id="stat-åœ°çƒ">0</div>
      </div>
    </div>

    <div class="main-content">
      <div class="chart-box">
        <h3 style="margin-top:0">æ¯”ä¾‹åˆ†ä½ˆ</h3>
        <div style="height: 300px; position: relative;">
          <canvas id="myChart"></canvas>
        </div>
      </div>

      <div class="list-box">
        <div class="list-header">
          <h3 id="listTitle" style="margin:0">æ‰€æœ‰ç•™è¨€</h3>
        </div>
        <div id="msg-list">æ­£åœ¨åŒæ­¥è³‡æ–™åº«...</div>
      </div>
    </div>
  </div>

  <script>
    // 1. â˜… è«‹å¡«å…¥æ‚¨çš„ Firebase Config â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyBgdiXsmiQMuMaZrMPov6vLWjaPa7midPo",
      authDomain: "say-something-pgyhotgirl0828.firebaseapp.com",
      databaseURL: "https://say-something-pgyhotgirl0828-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "say-something-pgyhotgirl0828",
      storageBucket: "say-something-pgyhotgirl0828.firebasestorage.app",
      messagingSenderId: "210742229763",
      appId: "1:210742229763:web:0d998347d4dc1e26098736"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref("messages");

    let allData = [];            // å­˜æ”¾æ‰€æœ‰ç•™è¨€çš„é™£åˆ—
    let currentFilterTopic = ""; // ç•¶å‰ç¯©é¸çš„ä¸»é¡Œ
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');

    // 2. åˆå§‹æ—¥æœŸè¨­å®šï¼šé è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©
    function initDateRange() {
      const today = new Date();
      const lastWeek = new Date();
      lastWeek.setDate(today.getDate() - 6);

      startDateEl.value = lastWeek.toISOString().split('T')[0];
      endDateEl.value = today.toISOString().split('T')[0];
    }

    // 3. ç›£è½ Firebase è³‡æ–™æ›´æ–° (å³æ™‚åŒæ­¥)
    dbRef.on("value", (snapshot) => {
      const val = snapshot.val();
      if (!val) {
        document.getElementById("msg-list").innerHTML = "ç›®å‰å°šç„¡è³‡æ–™";
        return;
      }
      
      // è½‰æ›è³‡æ–™ä¸¦æŒ‰æ™‚é–“å€’åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨å‰ï¼‰
      allData = Object.entries(val).map(([id, data]) => ({ id, ...data }));
      allData.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      
      updateDashboard();
    });

    // 4. ç›£è½æ—¥æœŸè®Šå‹•
    startDateEl.addEventListener('change', updateDashboard);
    endDateEl.addEventListener('change', updateDashboard);

    // 5. ä¸»é¡Œç¯©é¸åŠŸèƒ½
    function filterByTopic(topic) {
      currentFilterTopic = topic;
      // åˆ‡æ›å¡ç‰‡ active æ¨£å¼
      document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
      if(!topic) document.getElementById('card-all').classList.add('active');
      else document.getElementById('card-' + topic).classList.add('active');
      
      updateDashboard();
    }

    // 6. æ ¸å¿ƒï¼šæ›´æ–°ç•«é¢æ‰€æœ‰çµ±è¨ˆèˆ‡åˆ—è¡¨
    function updateDashboard() {
      const start = startDateEl.value; // YYYY-MM-DD
      const end = endDateEl.value;     // YYYY-MM-DD

      if (!start || !end) return;

      // A. å…ˆä¾æ“šæ—¥æœŸå€é–“éæ¿¾ (ä½¿ç”¨å­—ä¸²æ¯”è¼ƒ)
      const rangeData = allData.filter(item => {
        const itemDate = new Date(item.createdAt).toISOString().split('T')[0];
        return itemDate >= start && itemDate <= end;
      });

      // B. è¨ˆç®—çµ±è¨ˆæ•¸å­— (åŸºæ–¼æ—¥æœŸå€é–“å…§çš„å…¨è²Œ)
      const stats = { "å”å¯¶å¯¶": 0, "ç¤¾æœƒ": 0, "åœ°çƒ": 0 };
      rangeData.forEach(item => {
        if(stats.hasOwnProperty(item.topic)) stats[item.topic]++;
      });

      // C. æ›´æ–°å¡ç‰‡æ•¸å­—
      document.getElementById('stat-total').innerText = rangeData.length;
      document.getElementById('stat-å”å¯¶å¯¶').innerText = stats["å”å¯¶å¯¶"];
      document.getElementById('stat-ç¤¾æœƒ').innerText = stats["ç¤¾æœƒ"];
      document.getElementById('stat-åœ°çƒ').innerText = stats["åœ°çƒ"];

      // D. æ ¹æ“šä¸»é¡Œé€²ä¸€æ­¥éæ¿¾è¦é¡¯ç¤ºçš„åˆ—è¡¨
      const finalDisplayData = currentFilterTopic 
        ? rangeData.filter(d => d.topic === currentFilterTopic)
        : rangeData;

      // E. æ¸²æŸ“åˆ—è¡¨
      renderList(finalDisplayData);
      
      // æ›´æ–°æ¨™é¡Œ
      const topicTitle = currentFilterTopic ? `[${currentFilterTopic}]` : "[å…¨éƒ¨]";
      document.getElementById('listTitle').innerText = `${start} ~ ${end} ${topicTitle}`;

      // F. æ›´æ–°åœ“é¤…åœ–
      updateChart(stats);
    }

    function renderList(data) {
      const listEl = document.getElementById("msg-list");
      if (data.length === 0) {
        listEl.innerHTML = "<div style='text-align:center; color:#999; margin-top:20px;'>æ­¤å€é–“ç„¡ç›¸é—œç•™è¨€</div>";
        return;
      }

      let listHtml = "";
      data.forEach(item => {
        const dateObj = new Date(item.createdAt);
        const dateStr = dateObj.toLocaleDateString();
        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        listHtml += `
          <div class="msg-item">
            <span class="topic-tag tag-${item.topic}">${item.topic}</span>
            <div class="msg-text">${item.message}</div>
            <div class="msg-time">${dateStr} ${timeStr}</div>
          </div>
        `;
      });
      listEl.innerHTML = listHtml;
    }

    function resetFilters() {
      initDateRange();
      filterByTopic('');
    }

    // 7. åœ–è¡¨è™•ç†
    let myChart;
    function updateChart(stats) {
      const ctx = document.getElementById('myChart').getContext('2d');
      const chartData = [stats["å”å¯¶å¯¶"], stats["ç¤¾æœƒ"], stats["åœ°çƒ"]];
      
      if (myChart) {
        myChart.data.datasets[0].data = chartData;
        myChart.update();
      } else {
        myChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['å”å¯¶å¯¶', 'ç¤¾æœƒ', 'åœ°çƒ'],
            datasets: [{
              data: chartData,
              backgroundColor: ['#ffeaa7', '#fab1a0', '#55efc4'],
              hoverOffset: 4
            }]
          },
          options: {
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }
    }

    // å•Ÿå‹•åŸ·è¡Œ
    initDateRange();
  </script>
</body>
</html>