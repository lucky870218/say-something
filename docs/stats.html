<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>留言募集｜數據統計中心</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    
    /* 統計卡片 */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .card { background: #fff; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .card h3 { margin: 0; font-size: 14px; color: #666; }
    .card .num { font-size: 28px; font-weight: bold; margin-top: 10px; color: #111; }

    /* 圖表與列表 */
    .main-content { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
    @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } }
    
    .chart-box, .list-box { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    
    .list-box { max-height: 500px; overflow-y: auto; }
    .msg-item { border-bottom: 1px solid #eee; padding: 12px 0; }
    .msg-item:last-child { border: 0; }
    .msg-topic { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 5px; }
    .topic-唐寶寶 { background: #ffeaa7; color: #d35400; }
    .topic-社會 { background: #fab1a0; color: #c0392b; }
    .topic-地球 { background: #55efc4; color: #009432; }
    .msg-text { font-size: 15px; line-height: 1.4; }
    .msg-time { font-size: 11px; color: #999; margin-top: 5px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>活動參與即時數據</h1>
      <p>目前資料庫與 Firebase 保持同步中</p>
    </div>

    <div class="stats-grid">
      <div class="card"><h3>總留言數</h3><div class="num" id="total-count">0</div></div>
      <div class="card"><h3>唐寶寶</h3><div class="num" id="count-唐寶寶">0</div></div>
      <div class="card"><h3>社會</h3><div class="num" id="count-社會">0</div></div>
      <div class="card"><h3>地球</h3><div class="num" id="count-地球">0</div></div>
    </div>

    <div class="main-content">
      <div class="chart-box">
        <canvas id="myChart"></canvas>
      </div>

      <div class="list-box">
        <h3 style="margin-top:0">最新留言</h3>
        <div id="msg-list">載入中...</div>
      </div>
    </div>
  </div>

  <script>
    // 1. ★ 請填入跟你 index.html 一模一樣的 Firebase Config ★
    const firebaseConfig = {
        apiKey: "AIzaSyBgdiXsmiQMuMaZrMPov6vLWjaPa7midPo",
        authDomain: "say-something-pgyhotgirl0828.firebaseapp.com",
        databaseURL: "https://say-something-pgyhotgirl0828-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "say-something-pgyhotgirl0828",
        storageBucket: "say-something-pgyhotgirl0828.firebasestorage.app",
        messagingSenderId: "210742229763",
        appId: "1:210742229763:web:0d998347d4dc1e26098736"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref("messages");

    // 初始化 Chart.js
    const ctx = document.getElementById('myChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['唐寶寶', '社會', '地球'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ['#ffeaa7', '#fab1a0', '#55efc4']
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    // 監聽 Firebase 資料變化
    dbRef.on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      let counts = { "唐寶寶": 0, "社會": 0, "地球": 0 };
      let listHtml = "";
      const entries = Object.values(data).reverse(); // 最新的在前

      entries.forEach(item => {
        // 統計各對象數量
        if (counts.hasOwnProperty(item.topic)) {
          counts[item.topic]++;
        }
        
        // 建立留言 HTML
        const time = item.createdAt ? new Date(item.createdAt).toLocaleString() : "";
        listHtml += `
          <div class="msg-item">
            <span class="msg-topic topic-${item.topic}">${item.topic}</span>
            <div class="msg-text">${item.message}</div>
            <div class="msg-time">${time}</div>
          </div>
        `;
      });

      // 更新數字卡片
      document.getElementById("total-count").innerText = entries.length;
      document.getElementById("count-唐寶寶").innerText = counts["唐寶寶"];
      document.getElementById("count-社會").innerText = counts["社會"];
      document.getElementById("count-地球").innerText = counts["地球"];

      // 更新列表
      document.getElementById("msg-list").innerHTML = listHtml;

      // 更新圖表
      myChart.data.datasets[0].data = [counts["唐寶寶"], counts["社會"], counts["地球"]];
      myChart.update();
    });
  </script>
</body>
</html>