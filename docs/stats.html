<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ç•™è¨€å‹Ÿé›†ï½œæ•¸æ“šçµ±è¨ˆä¸­å¿ƒ</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    
    /* ç¯©é¸æ§åˆ¶åˆ— */
    .filter-bar { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    input[type="date"] { padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .card { background: #fff; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
    .card:hover { border-color: #007bff; }
    .card.active { border-color: #007bff; background: #e7f3ff; }
    .card h3 { margin: 0; font-size: 14px; color: #666; }
    .card .num { font-size: 24px; font-weight: bold; margin-top: 5px; }

    .main-content { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; }
    .chart-box, .list-box { background: #fff; padding: 20px; border-radius: 12px; }
    .list-box { max-height: 600px; overflow-y: auto; }
    
    .msg-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    .topic-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }
    .tag-å”å¯¶å¯¶ { background: #ffeaa7; } .tag-ç¤¾æœƒ { background: #fab1a0; } .tag-åœ°çƒ { background: #55efc4; }
  </style>
</head>
<body>

<div class="container">
  <div class="filter-bar">
    <div class="filter-group">
      <strong>ğŸ“… é¸æ“‡æ—¥æœŸï¼š</strong>
      <input type="date" id="datePicker">
      <button onclick="resetFilters()">é‡ç½®å…¨éƒ¨</button>
    </div>
    <div id="filterStatus" style="font-size: 14px; color: #007bff;"></div>
  </div>

  <div class="stats-grid">
    <div class="card active" id="card-all" onclick="filterByTopic('')">
      <h3>ç•¶æ—¥ç¸½ç•™è¨€</h3><div class="num" id="stat-total">0</div>
    </div>
    <div class="card" id="card-å”å¯¶å¯¶" onclick="filterByTopic('å”å¯¶å¯¶')">
      <h3>å”å¯¶å¯¶</h3><div class="num" id="stat-å”å¯¶å¯¶">0</div>
    </div>
    <div class="card" id="card-ç¤¾æœƒ" onclick="filterByTopic('ç¤¾æœƒ')">
      <h3>ç¤¾æœƒ</h3><div class="num" id="stat-ç¤¾æœƒ">0</div>
    </div>
    <div class="card" id="card-åœ°çƒ" onclick="filterByTopic('åœ°çƒ')">
      <h3>åœ°çƒ</h3><div class="num" id="stat-åœ°çƒ">0</div>
    </div>
  </div>

  <div class="main-content">
    <div class="chart-box">
      <canvas id="myChart"></canvas>
    </div>
    <div class="list-box">
      <h3 id="listTitle">å…¨éƒ¨ç•™è¨€</h3>
      <div id="msg-list">è®€å–ä¸­...</div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBgdiXsmiQMuMaZrMPov6vLWjaPa7midPo",
    authDomain: "say-something-pgyhotgirl0828.firebaseapp.com",
    databaseURL: "https://say-something-pgyhotgirl0828-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "say-something-pgyhotgirl0828",
    storageBucket: "say-something-pgyhotgirl0828.firebasestorage.app",
    messagingSenderId: "210742229763",
    appId: "1:210742229763:web:0d998347d4dc1e26098736"
  };
  firebase.initializeApp(firebaseConfig);
  const dbRef = firebase.database().ref("messages");

  let allData = []; // å­˜å„²æ‰€æœ‰åŸå§‹è³‡æ–™
  let currentFilterDate = ""; // ç•¶å‰ç¯©é¸æ—¥æœŸ
  let currentFilterTopic = ""; // ç•¶å‰ç¯©é¸å°è±¡

  // 1. åˆå§‹è¼‰å…¥
  dbRef.on("value", (snapshot) => {
    const val = snapshot.val();
    if (!val) return;
    // å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—ä¸¦æ’åº
    allData = Object.entries(val).map(([id, data]) => ({ id, ...data }));
    allData.sort((a, b) => b.createdAt - a.createdAt);
    
    // å¦‚æœæ²’é¸æ—¥æœŸï¼Œé è¨­é¸ä»Šå¤©
    if(!currentFilterDate) {
      document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];
      currentFilterDate = document.getElementById('datePicker').value;
    }
    updateDashboard();
  });

  // 2. ç›£è½æ—¥æœŸè®Šæ›´
  document.getElementById('datePicker').addEventListener('change', (e) => {
    currentFilterDate = e.target.value;
    currentFilterTopic = ""; // æ›æ—¥æœŸæ™‚é‡ç½®ä¸»é¡Œç¯©é¸
    updateDashboard();
  });

  // 3. ä¸»é¡Œç¯©é¸åˆ‡æ›
  function filterByTopic(topic) {
    currentFilterTopic = topic;
    // åˆ‡æ›å¡ç‰‡æ¨£å¼
    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
    if(!topic) document.getElementById('card-all').classList.add('active');
    else document.getElementById('card-' + topic).classList.add('active');
    
    updateDashboard();
  }

  // 4. æ ¸å¿ƒé‚è¼¯ï¼šæ›´æ–°å„€è¡¨æ¿
  function updateDashboard() {
    // A. æ ¹æ“šæ—¥æœŸç¯©é¸è³‡æ–™
    const dailyData = allData.filter(item => {
      const itemDate = new Date(item.createdAt).toISOString().split('T')[0];
      return itemDate === currentFilterDate;
    });

    // B. è¨ˆç®—è©²æ—¥æœŸçš„çµ±è¨ˆæ•¸å­— (ä¸ç®¡æœ‰æ²’æœ‰é¸ä¸»é¡Œï¼Œæ•¸å­—å¡ç‰‡éƒ½è¦é¡¯ç¤ºè©²æ—¥å…¨è²Œ)
    const stats = { "å”å¯¶å¯¶": 0, "ç¤¾æœƒ": 0, "åœ°çƒ": 0 };
    dailyData.forEach(d => { if(stats.hasOwnProperty(d.topic)) stats[d.topic]++; });

    document.getElementById('stat-total').innerText = dailyData.length;
    document.getElementById('stat-å”å¯¶å¯¶').innerText = stats["å”å¯¶å¯¶"];
    document.getElementById('stat-ç¤¾æœƒ').innerText = stats["ç¤¾æœƒ"];
    document.getElementById('stat-åœ°çƒ').innerText = stats["åœ°çƒ"];

    // C. æ ¹æ“šä¸»é¡Œé€²ä¸€æ­¥éæ¿¾è¦é¡¯ç¤ºçš„åˆ—è¡¨
    const finalDisplayData = currentFilterTopic 
      ? dailyData.filter(d => d.topic === currentFilterTopic)
      : dailyData;

    // D. æ¸²æŸ“åˆ—è¡¨
    let listHtml = "";
    finalDisplayData.forEach(item => {
      const timeStr = new Date(item.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      listHtml += `
        <div class="msg-item">
          <span class="topic-tag tag-${item.topic}">${item.topic}</span>
          <div style="font-size:15px">${item.message}</div>
          <div style="font-size:11px; color:#999; margin-top:5px;">${timeStr}</div>
        </div>
      `;
    });
    document.getElementById('msg-list').innerHTML = listHtml || "è©²ç¯©é¸æ¢ä»¶ä¸‹ç„¡ç•™è¨€";
    document.getElementById('listTitle').innerText = `${currentFilterDate} ${currentFilterTopic || 'å…¨éƒ¨'}ç•™è¨€`;

    // E. æ›´æ–°åœ–è¡¨
    updateChart(stats);
  }

  function resetFilters() {
    currentFilterDate = new Date().toISOString().split('T')[0];
    document.getElementById('datePicker').value = currentFilterDate;
    filterByTopic('');
  }

  // åœ–è¡¨è™•ç†
  let myChart;
  function updateChart(stats) {
    const ctx = document.getElementById('myChart').getContext('2d');
    const chartData = [stats["å”å¯¶å¯¶"], stats["ç¤¾æœƒ"], stats["åœ°çƒ"]];
    
    if (myChart) {
      myChart.data.datasets[0].data = chartData;
      myChart.update();
    } else {
      myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å”å¯¶å¯¶', 'ç¤¾æœƒ', 'åœ°çƒ'],
          datasets: [{ data: chartData, backgroundColor: ['#ffeaa7', '#fab1a0', '#55efc4'] }]
        },
        options: { maintainAspectRatio: false }
      });
    }
  }
</script>
</body>
</html>